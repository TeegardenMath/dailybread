// MASH Game Data - Large varied lists
const gameData = {
    home: {
        title: "Home",
        options: [
            "Mansion", "Apartment", "Shack", "House", "Penthouse", "Treehouse", "Houseboat",
            "Castle", "Cave", "Igloo", "Tent", "RV", "Lighthouse", "Windmill", "Barn",
            "Underground bunker", "Space station", "Tiny house", "McMansion", "Yurt",
            "Converted school bus", "Shipping container", "Hut on chicken legs", "Glass house",
            "Victorian manor", "Beach shack", "Mountain cabin", "Underwater dome", "Ice palace",
            "Floating island", "Abandoned mall", "Repurposed church", "Geodesic dome", "Hobbit hole",
            "Converted water tower", "Haunted mansion", "Farmhouse", "Airstream trailer", "Ski chalet",
            "Tropical bungalow", "Brutalist tower", "Cottage in the woods", "Desert compound", "Stilt house",
            "A very large shoe", "A really nice cardboard box", "Abandoned theme park", "Converted missile silo",
            "Monastery", "Old firehouse", "Beachfront property (eroding rapidly)", "Houseboat that can't move"
        ]
    },
    spouse: {
        title: "Spouse",
        options: [
            "Your high school crush", "A famous actor", "The mailman", "Your best friend", "A mysterious stranger",
            "Someone you met on the internet", "Your rival", "A time traveler", "An AI", "A ghost",
            "Your dentist", "Someone who doesn't speak your language", "A clone of yourself", "Your boss",
            "Someone from a different century", "A cryptid", "Your Uber driver", "A reformed villain",
            "Someone you've never met", "Your ex's best friend", "A talking animal", "Someone invisible",
            "Your parallel universe self", "A wax statue that came to life", "The moon (personified)",
            "Someone who thinks they're a vampire (they're not)", "A very ambitious mime", "Your sleep paralysis demon",
            "Someone who exclusively communicates in riddles", "A professional whistler", "Your childhood imaginary friend",
            "Someone allergic to everything", "A former cult leader (reformed)", "Your doctor",
            "Someone who collects teeth", "A haunted doll", "Your nemesis", "Someone incredibly average",
            "A retired spy", "Someone who won't stop talking about their podcast", "Your landlord",
            "Someone from witness protection", "A shapeshifter stuck in one form", "Your coworker",
            "Someone who thinks everything is a conspiracy", "A professional video game player", "Your therapist",
            "Someone who insists they invented Bitcoin", "A method actor who won't break character", "Your mechanic"
        ]
    },
    car: {
        title: "Car",
        options: [
            "Tesla", "Toyota Camry", "Minivan", "Motorcycle", "Bicycle", "Skateboard", "Horse and buggy",
            "Lamborghini", "Tricycle", "Hoverboard", "Segway", "Hot air balloon", "Rocket ship", "Magic carpet",
            "Shopping cart", "Zamboni", "Monster truck", "Ice cream truck", "Hearse", "Invisible car",
            "Oscar Mayer Wienermobile", "Riding lawnmower", "Golf cart", "Jet ski (on land)", "Pogo stick",
            "Unicycle", "Penny-farthing", "Chariot", "Sleigh pulled by dogs", "Time machine (broken)",
            "Clown car", "Mystery Machine", "Batmobile (replica)", "PT Cruiser", "Smart car",
            "Hummer (gas mileage: concerning)", "DeLorean", "Volkswagen Beetle (the old kind)", "Sedan chair carried by servants",
            "Rickshaw", "Tuk-tuk", "Your own two feet", "Very fast snail", "Rascal scooter", "Zamboni (yes, again)",
            "Vespa", "Segway (but it's haunted)", "Extremely long limousine", "Cybertruck", "Bus pass"
        ]
    },
    kids: {
        title: "Kids",
        options: [
            "0", "1", "2", "3", "4", "5", "7", "10", "13", "20",
            "100 (you run an orphanage)", "Twins", "Triplets", "Quadruplets", "Lost count",
            "None but 47 cats", "One very large child", "Several small children of uncertain number",
            "Negative 2 (don't ask)", "Too many", "Just the right amount", "3.5 (one is half yours)",
            "A classroom full", "An even dozen", "A baker's dozen", "None but everyone thinks you have kids",
            "12 but they're all the same person at different ages", "One kid but they're incredibly difficult",
            "200 (you're a school principal)", "6 (all named the same thing)", "None (just fur babies)",
            "1 but they're actually 3 kids in a trenchcoat", "An undisclosed number", "A sensible amount",
            "More than you can afford", "Exactly as many as you have seats in your car", "None but lots of plants you call your babies",
            "17 (you started a band)", "9 (baseball team)", "11 (soccer team)", "30 (you teach kindergarten)",
            "Zero but everyone assumes you do", "One surprise child from the future", "Countless (time loop situation)",
            "One but they're a genius", "Five sets of twins", "An entire daycare worth", "Just one very tiny elephant (you don't question it)"
        ]
    },
    job: {
        title: "Job",
        options: [
            "Doctor", "Lawyer", "Teacher", "Programmer", "Artist", "Chef", "Janitor", "CEO",
            "Professional napper", "Astronaut", "Detective", "Superhero", "Supervillain", "Time cop",
            "Professional mourner", "Underwater basket weaver", "Professional cuddler", "Pet psychic",
            "Pirate", "Knight", "Dragon tamer", "Cloud painter", "Professional line-stander",
            "Meme archaeologist", "Professional complainer", "Competitive eater", "Palindrome writer",
            "Emoji translator", "Professional conspiracy theorist", "Bigfoot tracker", "Ghost hunter",
            "Wizard", "Fortune teller (ironic)", "Professional sleeper for mattress testing", "Iceberg mover",
            "Professional Netflix watcher", "Cat video curator", "Dream interpreter", "Professional third wheel",
            "Influencer (0 followers)", "Taxidermist", "Beekeeper", "Storm chaser", "Puppeteer",
            "Cryptozoologist", "Professional whistler", "Food truck owner", "Museum guard", "Park ranger",
            "Lighthouse keeper", "Professional organizer", "Life coach", "Feng shui consultant", "Snake milker",
            "Professional bridesmaid for hire", "Renaissance fair performer", "Paranormal investigator", "Treasure hunter (unsuccessful)",
            "Competitive air guitarist", "Social media manager for a cat", "Professional gift wrapper", "Escape room designer",
            "Sleep scientist", "Professional procrastinator", "Balloon animal artist", "Voice of automated phone systems",
            "Professional hermit", "Presidential portrait artist", "Competitive cup stacker", "Beard model"
        ]
    },
    location: {
        title: "Location",
        options: [
            "New York", "Los Angeles", "London", "Paris", "Tokyo", "Dubai", "Sydney", "Toronto",
            "Antarctica", "The Moon", "Mars", "A deserted island", "Atlantis", "Narnia", "Hogwarts",
            "The Upside Down", "Middle Earth", "Gotham City", "A parallel dimension", "Your hometown (you never left)",
            "The bottom of the ocean", "International waters", "The North Pole", "A floating city",
            "Underground", "The Matrix", "A simulation", "Witness protection in Iowa", "A nice suburb",
            "A compound in the woods", "International Space Station", "A place that doesn't exist yet",
            "Nowhere specific (you're a nomad)", "Bermuda Triangle", "Area 51", "A volcano (active)",
            "The Metaverse", "A Renaissance fair (permanent resident)", "A cruise ship that never docks",
            "Siberia", "Death Valley", "The Amazon Rainforest", "A haunted New England village",
            "Las Vegas", "A ski resort town", "A beach town that's slowly sinking", "The cloud (literally)",
            "A space station orbiting Jupiter", "A biodome on Mars", "Inside a video game", "A pocket dimension",
            "The Twilight Zone", "A timeline that got pruned but you survived", "Seattle (it never stops raining)",
            "Phoenix (it never stops being hot)", "A small town with a dark secret", "The place time forgot",
            "A rest stop off I-95", "An abandoned shopping mall", "Inside a whale (Jonah-style)", "The backrooms",
            "A very fancy airport lounge", "A monastery in Tibet", "A lighthouse in Maine", "Literally nowhere (the void)",
            "Gary, Indiana", "A houseboat in Amsterdam", "An ashram in India", "A castle in Scotland",
            "A favela in Rio", "A hutong in Beijing", "Somewhere without Wi-Fi (nightmare)"
        ]
    },
    salary: {
        title: "Annual Salary",
        options: [
            "$20,000", "$35,000", "$50,000", "$75,000", "$100,000", "$150,000", "$250,000", "$500,000",
            "$1 million", "$10 million", "$100 million", "$1 billion", "$0 (you live off the land)",
            "$12,000 (minimum wage)", "$45,000", "$85,000", "$120,000", "$200,000", "$350,000",
            "$2 million", "$5 million", "$50 million", "Whatever you find in couch cushions",
            "$7.50 per hour", "One Bitcoin (value fluctuates wildly)", "Paid in exposure",
            "Unlimited breadsticks", "Room and board only", "$25,000 but full benefits",
            "$90,000", "$65,000", "$180,000", "$400,000", "$750,000", "$15 million",
            "Enough to get by", "More than you need", "Less than you deserve", "Paid in eggs and milk",
            "$30,000 (plus tips)", "$55,000", "$95,000", "$140,000", "$225,000", "$600,000",
            "Wealth beyond measure", "Comfortable but not rich", "Barely scraping by", "$42,069 (nice)",
            "Paid in compliments", "Three chickens a week", "$1 per year (you're doing it for passion)",
            "$80,000", "$110,000", "$175,000", "$300,000", "$1.5 million", "Paid in company stock (worthless)",
            "Monopoly money", "Enough to retire immediately", "Not enough to retire ever", "Cryptocurrency (dubious)",
            "$60,000", "$88,000", "$125,000", "$190,000", "$280,000", "$450,000", "$800,000"
        ]
    }
};

// Game state
let gameState = {
    selections: {},
    spiralNumber: 0,
    allItems: []
};

// Initialize game
function init() {
    setupCategories();
    document.getElementById('start-spiral').addEventListener('click', startSpiralPhase);
    document.getElementById('play-again').addEventListener('click', resetGame);
    document.getElementById('share-twitter').addEventListener('click', shareTwitter);
    document.getElementById('share-tumblr').addEventListener('click', shareTumblr);
    document.getElementById('copy-discord').addEventListener('click', copyDiscord);
}

// Setup categories with three items each
function setupCategories() {
    const container = document.getElementById('categories');

    Object.keys(gameData).forEach(categoryKey => {
        const category = gameData[categoryKey];
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';

        const title = document.createElement('div');
        title.className = 'category-title';
        title.textContent = category.title;
        categoryDiv.appendChild(title);

        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'category-items';

        // Three items per category
        // 1. User input
        const userItem = createUserInput(categoryKey);
        itemsDiv.appendChild(userItem);

        // 2. Random with limited rerolls
        const rerollItem = createRerollItem(categoryKey, category.options);
        itemsDiv.appendChild(rerollItem);

        // 3. Random with no rerolls
        const lockedItem = createLockedItem(categoryKey, category.options);
        itemsDiv.appendChild(lockedItem);

        categoryDiv.appendChild(itemsDiv);
        container.appendChild(categoryDiv);
    });
}

function createUserInput(categoryKey) {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.dataset.category = categoryKey;
    item.dataset.type = 'user';

    const number = document.createElement('span');
    number.className = 'item-number';
    number.textContent = '1.';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = '...';
    input.dataset.categoryKey = categoryKey;

    const content = document.createElement('div');
    content.className = 'item-content';
    content.appendChild(input);

    item.appendChild(number);
    item.appendChild(content);

    return item;
}

function createRerollItem(categoryKey, options) {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.dataset.category = categoryKey;
    item.dataset.type = 'reroll';

    const number = document.createElement('span');
    number.className = 'item-number';
    number.textContent = '2.';

    const content = document.createElement('div');
    content.className = 'item-content';

    const display = document.createElement('div');
    display.className = 'random-display';

    const usedOptions = new Set();
    let rerollsLeft = 3;

    function getRandomOption() {
        const available = options.filter(opt => !usedOptions.has(opt));
        if (available.length === 0) return options[Math.floor(Math.random() * options.length)];
        return available[Math.floor(Math.random() * available.length)];
    }

    let currentOption = getRandomOption();
    usedOptions.add(currentOption);

    const text = document.createElement('span');
    text.className = 'random-text';
    text.textContent = currentOption;

    const rerollBtn = document.createElement('button');
    rerollBtn.className = 'reroll-btn';
    rerollBtn.textContent = 'â†»';
    rerollBtn.title = `${rerollsLeft} rerolls left`;

    rerollBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (rerollsLeft > 0) {
            currentOption = getRandomOption();
            usedOptions.add(currentOption);
            text.textContent = currentOption;
            rerollsLeft--;
            rerollBtn.title = rerollsLeft > 0 ? `${rerollsLeft} rerolls left` : 'No rerolls left';
            if (rerollsLeft === 0) {
                rerollBtn.disabled = true;
            }
        }
    });

    display.appendChild(text);
    display.appendChild(rerollBtn);
    content.appendChild(display);

    item.appendChild(number);
    item.appendChild(content);
    item.dataset.value = currentOption;

    // Update dataset when rerolled
    rerollBtn.addEventListener('click', () => {
        item.dataset.value = currentOption;
    });

    return item;
}

function createLockedItem(categoryKey, options) {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.dataset.category = categoryKey;
    item.dataset.type = 'locked';

    const number = document.createElement('span');
    number.className = 'item-number';
    number.textContent = '3.';

    const randomOption = options[Math.floor(Math.random() * options.length)];

    const content = document.createElement('div');
    content.className = 'item-content';
    content.textContent = randomOption;

    item.appendChild(number);
    item.appendChild(content);
    item.dataset.value = randomOption;

    return item;
}

// Spiral phase
function startSpiralPhase() {
    // Collect all selections
    const items = document.querySelectorAll('.category-item');
    gameState.allItems = [];

    items.forEach(item => {
        const category = item.dataset.category;
        const type = item.dataset.type;

        let value;
        if (type === 'user') {
            const input = item.querySelector('input');
            value = input.value.trim() || 'Nothing';
        } else {
            value = item.dataset.value;
        }

        gameState.allItems.push({
            category,
            value,
            element: item.cloneNode(true)
        });
    });

    // Show spiral screen
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('spiral-screen').classList.remove('hidden');

    startSpiralDrawing();
}

function startSpiralDrawing() {
    const canvas = document.getElementById('spiral-canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = 600;
    canvas.height = 600;

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    let angle = 0;
    let radius = 5;
    let drawing = true;

    ctx.strokeStyle = '#2c2416';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);

    function drawSpiral() {
        if (!drawing) return;

        angle += 0.15;
        radius += 0.15;

        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);

        ctx.lineTo(x, y);
        ctx.stroke();

        if (radius < 280) {
            requestAnimationFrame(drawSpiral);
        } else {
            // Spiral reached edge, loop back
            angle = 0;
            radius = 5;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            requestAnimationFrame(drawSpiral);
        }
    }

    drawSpiral();

    // Stop on spacebar
    document.addEventListener('keydown', function stopSpiral(e) {
        if (e.code === 'Space' && drawing) {
            e.preventDefault();
            drawing = false;
            document.removeEventListener('keydown', stopSpiral);

            // Calculate elimination number based on spiral length
            const spiralLength = Math.floor(radius / 10);
            gameState.spiralNumber = Math.max(2, spiralLength % 15 || 7);

            setTimeout(() => startElimination(), 500);
        }
    });
}

// Elimination phase
function startElimination() {
    document.getElementById('spiral-screen').classList.add('hidden');
    document.getElementById('elimination-screen').classList.remove('hidden');

    const display = document.getElementById('elimination-display');

    // Rebuild categories display
    const categories = {};
    gameState.allItems.forEach(item => {
        if (!categories[item.category]) {
            categories[item.category] = {
                title: gameData[item.category].title,
                items: []
            };
        }
        categories[item.category].items.push(item);
    });

    Object.keys(categories).forEach(catKey => {
        const cat = categories[catKey];
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';

        const title = document.createElement('div');
        title.className = 'category-title';
        title.textContent = cat.title;
        categoryDiv.appendChild(title);

        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'category-items';

        cat.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'category-item';
            itemDiv.textContent = item.value;
            itemDiv.dataset.category = item.category;
            itemDiv.dataset.eliminated = 'false';
            itemsDiv.appendChild(itemDiv);
            item.displayElement = itemDiv;
        });

        categoryDiv.appendChild(itemsDiv);
        display.appendChild(categoryDiv);
    });

    // Start elimination animation
    setTimeout(() => animateElimination(), 1000);
}

function animateElimination() {
    const items = [...gameState.allItems];
    const eliminationNumber = gameState.spiralNumber;
    let currentIndex = 0;
    let count = 0;

    function eliminateNext() {
        if (items.filter(item => !item.eliminated).length === Object.keys(gameData).length) {
            // One item left per category
            setTimeout(() => showResults(), 1000);
            return;
        }

        // Find next non-eliminated item
        let attempts = 0;
        while (items[currentIndex].eliminated && attempts < items.length * 2) {
            currentIndex = (currentIndex + 1) % items.length;
            attempts++;
        }

        if (attempts >= items.length * 2) {
            setTimeout(() => showResults(), 1000);
            return;
        }

        // Highlight current item
        items[currentIndex].displayElement.classList.add('highlight');

        count++;

        setTimeout(() => {
            items[currentIndex].displayElement.classList.remove('highlight');

            if (count === eliminationNumber) {
                // Eliminate this item (only if not the last in category)
                const category = items[currentIndex].category;
                const remainingInCategory = items.filter(item =>
                    item.category === category && !item.eliminated
                );

                if (remainingInCategory.length > 1) {
                    items[currentIndex].eliminated = true;
                    items[currentIndex].displayElement.classList.add('crossed-out');
                }
                count = 0;
            }

            currentIndex = (currentIndex + 1) % items.length;
            setTimeout(eliminateNext, 400);
        }, 300);
    }

    eliminateNext();
}

// Results phase
function showResults() {
    document.getElementById('elimination-screen').classList.add('hidden');

    // Circle the winners
    gameState.allItems.forEach(item => {
        if (!item.eliminated) {
            item.displayElement.classList.add('final');
        }
    });

    setTimeout(() => {
        document.getElementById('elimination-screen').classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        const winners = {};
        gameState.allItems.forEach(item => {
            if (!item.eliminated) {
                winners[item.category] = item.value;
            }
        });

        gameState.winners = winners;

        Object.keys(gameData).forEach(catKey => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';

            const label = document.createElement('div');
            label.className = 'result-label';
            label.textContent = gameData[catKey].title;

            const value = document.createElement('div');
            value.className = 'result-value';
            value.textContent = winners[catKey] || 'Unknown';

            resultItem.appendChild(label);
            resultItem.appendChild(value);
            resultsDiv.appendChild(resultItem);
        });
    }, 1500);
}

// Share functions
function getResultsText() {
    const winners = gameState.winners;
    let text = 'ðŸ”® My MASH Future ðŸ”®\n\n';
    text += `ðŸ  Home: ${winners.home}\n`;
    text += `ðŸ’• Spouse: ${winners.spouse}\n`;
    text += `ðŸš— Car: ${winners.car}\n`;
    text += `ðŸ‘¶ Kids: ${winners.kids}\n`;
    text += `ðŸ’¼ Job: ${winners.job}\n`;
    text += `ðŸ“ Location: ${winners.location}\n`;
    text += `ðŸ’° Salary: ${winners.salary}\n`;
    return text;
}

function shareTwitter() {
    const text = encodeURIComponent(getResultsText() + '\n\nPlay MASH: ' + window.location.href);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
}

function shareTumblr() {
    const text = encodeURIComponent(getResultsText());
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.tumblr.com/widgets/share/tool?posttype=text&title=My%20MASH%20Future&content=${text}&canonicalUrl=${url}`, '_blank');
}

function copyDiscord() {
    const text = getResultsText();
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copy-discord');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    });
}

// Reset game
function resetGame() {
    gameState = {
        selections: {},
        spiralNumber: 0,
        allItems: []
    };

    document.getElementById('results-screen').classList.add('hidden');
    document.getElementById('elimination-screen').classList.add('hidden');
    document.getElementById('spiral-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');

    // Clear and rebuild
    document.getElementById('categories').innerHTML = '';
    document.getElementById('elimination-display').innerHTML = '';
    setupCategories();
}

// Start game
init();
